#'---
#' title: MAE cascade plot
#' author: vyepez, mumichae
#' wb:
#'  input:
#'   - maes: '`sm expand(parser.getProcDataDir() + "/mae/{id}.Rds", id = config["mae_ids"])`'
#'   - mae_res: '`sm parser.getProcReultsDir() + "/mae/MAE_results.Rds"`'
#'  output:
#'  threads: 40
#' output: 
#'   html_document:
#'    code_folding: show
#'    code_download: TRUE
#'---

#+ echo=F
saveRDS(snakemake, 'tmp/cascade_mae.Rds')
# snakemake <- readRDS('tmp/cascade_mae.Rds')
suppressPackageStartupMessages({
    devtools::load_all("../mae/")
    library(ggplot2)
    library(cowplot)
    library(ggpubr)
    library(plotly)
    library(magrittr)
})

#' ## Read all mae files
# maes <- list.files("/s/project/genetic_diagnosis/processed_data/mae/")
min_cov <- 10
BPPARAM = MulticoreParam(snakemake@threads, progressbar=TRUE)

#+ results = F
dt_mae <- bplapply(snakemake@input$maes, function(m){
    mae_table <- readRDS(m)
    # mae_table <- readRDS(file.path("/s/project/genetic_diagnosis/processed_data/mae/", m))
    ntotal <- length(mae_table)
    
    # subset for heterozygous mutation only
    mae_table$GT <- as.character(mae_table$GT)
    hetGT <- grepl('0[|/]1|1[|/]0', mae_table$GT, perl=TRUE)
    mae_table <- mae_table[hetGT]
    nhet <- length(mae_table)

    # subset for enough coverage
    mae_table$GQ <- as.integer(mae_table$GQ)
    goodCov <- mae_table$coverage >= min_cov
    mae_table <- mae_table[goodCov]
    nreads <- length(mae_table)
    
    rm(mae_table)
    return(c(ntotal, nhet, nreads))
    }, BPPARAM = BPPARAM
)

#'
names(dt_mae) <- snakemake@config$mae_ids

#' ## Get a data.table
m_dt <- melt(data.table(type = c("all", "het", "enough_counts"), as.data.table(dt_mae)), variable.name = 'sample')
m_dt[, sample := as.character(sample)]
m_dt[, sample := head(unlist(strsplit(sample, split = "\\.")), 1), by = 1:nrow(m_dt)]
m_dt[, type := factor(type, levels = c("all", "het", "enough_counts"))]

# Add results info
res_all <- readRDS(snakemake@input$mae_res)

# Add monoallelic
mr <- res_all[, .(value = .N), by = sample]
mr <- data.table(type = 'monoallelic', mr)

# Add rare
mr2 <- res_all[MAX_AF < 1e-3 | is.na(MAX_AF), .(value = .N), by = sample]
mr2 <- data.table(type = 'rare', mr2)


m_dt <- rbind(m_dt, mr, mr2)
saveRDS(m_dt, "Output/mae_freqs.Rds")

#' ## Plot
stat_box_data <- function(y, upper_limit = max(m_dt$value)) {
    data.frame(y = upper_limit, label = round(median(y), 1))
}
g <- ggplot(m_dt, aes(type, value, col = type)) +
    geom_boxplot() +
    scale_color_manual(values = c('black', 'grey50', 'grey70', 'dodgerblue', 'orangered')) +
    theme_bw(base_size = 14) + 
    labs(y = "SNVs per patient", x = "Filter cascade") +
    theme(legend.position = 'bottom')

#+ cascades, fig.height=8, fig.width=10
ggplotly(g + scale_y_log10())
g + grids() +
    stat_summary(fun.data = stat_box_data, geom = "text", vjust = -0.5) +
    coord_trans(y = 'log10')

m_dt[, median(value), by = type]
m_dt[value > 9e4]

